{"version":3,"file":"refractor.min.js","sources":["../../src/extension/refractor.js"],"sourcesContent":["/* eslint-disable no-console */\nimport {subscribe} from \"../extension\";\n\n/**\n * @param {HTMLElement} body\n * @param {string} query\n * @param {string} attr\n * @param {boolean} ishash\n * @param {string} prefix\n * @param {(ele: Element) => void} [changesWorker]\n * @returns {number}\n */\nfunction alphaWalker(body, query, attr, ishash, prefix, changesWorker) {\n    const all = body.querySelectorAll(query);\n    let casos = 0;\n    all.forEach((ele) => {\n        let localChange = 0;\n        let old = ele.getAttribute(attr) || \"\";\n        if (ishash) {\n            // It starts with # and after that the actual id value\n            if (attr === 'href') {\n                old = '#' + old.split('#')[1];\n            }\n            if (RegExp(/^#\\d/).exec(old)) {\n                ele.setAttribute(attr, '#' + prefix + old.substring(1));\n                localChange += 1;\n            }\n        } else if (RegExp(/^\\d/).exec(old)) {\n            ele.setAttribute(attr, prefix + old);\n            localChange += 1;\n        }\n        if (localChange && changesWorker) {\n            changesWorker(ele);\n        }\n        casos += localChange;\n    });\n    return casos;\n}\n\n/**\n * @param {Element} ele\n */\nfunction changesWorker(ele) {\n    const newId = ele.getAttribute(\"id\");\n    const allAs = ele.querySelectorAll('a.accordion-toggle[data-toggle=\"collapse\"],a.accordion-toggle[data-bs-toggle=\"collapse\"]');\n    allAs.forEach((asel) => {\n        asel.setAttribute(\"data-parent\", '#' + newId);\n        asel.setAttribute(\"data-bs-parent\", '#' + newId);\n    });\n}\n\n/**\n * @param {import(\"../plugin\").TinyMCE} editor\n * @returns {boolean}\n */\nexport function idFixingRefractor(editor) {\n    const prefix = 'f_';\n    let casos = 0;\n    const body = editor.getBody();\n    try {\n        casos += alphaWalker(body, '.accordion.iedib-accordion', 'id', false, prefix, changesWorker);\n        const casos2 = alphaWalker(body, 'ul.nav.nav-tabs>li>a', 'href', true, prefix);\n        if (casos2 > 0) {\n            casos += casos2 + alphaWalker(body, '.tab-pane.iedib-tabpane', 'id', false, prefix);\n        }\n    } catch (ex) {\n        console.error(ex);\n    }\n    return casos > 0;\n}\n\n// List of Bootstrap 4 data attribute suffixes (in kebab-case)\n// that are namespaced in Bootstrap 5.\nconst bs4DataAttributeSuffixes = [\n    // General triggers and component identifiers\n    'toggle',\n    'target',\n    'parent',\n    // Options and configurations\n    'placement',\n    'trigger',\n    'content',\n    'container',\n    'original-title',\n    'html',\n];\n\n // Create a CSS selector string to find elements with any of the BS4 data attributes\n const bs5Selectors = bs4DataAttributeSuffixes.map(suffix => `[data-${suffix}]`).join(',');\n\n/**\n * @param {import(\"../plugin\").TinyMCE} editor\n * @returns {boolean}\n */\nfunction bs5Refractor(editor) {\n    const body = editor.getBody();\n    let changes = 0;\n\n    // Select all elements that match the generated selector.\n    /** @type {HTMLElement[]} */\n    const elementsWithBs4DataAttributes = body.querySelectorAll(bs5Selectors);\n\n    elementsWithBs4DataAttributes.forEach(element => {\n        // Iterate over the list of known BS4 data attribute suffixes\n        bs4DataAttributeSuffixes.forEach(kebabCaseSuffix => {\n            const oldAttrName = `data-${kebabCaseSuffix}`;\n\n            // Check if the element has the old attribute\n            if (element.hasAttribute(oldAttrName)) {\n                const attrValue = element.getAttribute(oldAttrName);\n                const newAttrName = `data-bs-${kebabCaseSuffix}`;\n                // Add or update the new Bootstrap 5 attribute if it's not already set to the correct value.\n                // This \"duplicates\" by ensuring the data-bs-xxx attribute exists with the same value.\n                // It does not remove the old data-xxx attribute in this refactor.\n                if (attrValue !== null) {\n                    if (element.getAttribute(newAttrName) !== attrValue) {\n                        element.setAttribute(newAttrName, attrValue);\n                        changes++;\n                    }\n                } else {\n                    element.removeAttribute(newAttrName);\n                    changes++;\n                }\n            }\n        });\n    });\n\n    return changes > 0;\n}\n\n/**\n * @param {import(\"../plugin\").TinyMCE} editor\n */\nfunction refractoring(editor) {\n    const changes1 = idFixingRefractor(editor);\n    const changes2 = bs5Refractor(editor);\n    if (changes1 || changes2) {\n        editor.notificationManager.open({\n            text: \"S'han optimitzat alguns snippets. Per favor, desau els canvis en sortir.\",\n            type: 'warning',\n            timeout: 4000\n        });\n    }\n}\n\nsubscribe('onInit', refractoring);"],"names":["alphaWalker","body","query","attr","ishash","prefix","changesWorker","all","querySelectorAll","casos","forEach","ele","localChange","old","getAttribute","split","RegExp","exec","setAttribute","substring","newId","asel","idFixingRefractor","editor","getBody","casos2","ex","console","error","bs4DataAttributeSuffixes","bs5Selectors","map","suffix","join","changes1","changes2","changes","element","kebabCaseSuffix","oldAttrName","hasAttribute","attrValue","newAttrName","removeAttribute","bs5Refractor","notificationManager","open","text","type","timeout"],"mappings":"+GAYSA,YAAYC,KAAMC,MAAOC,KAAMC,OAAQC,OAAQC,qBAC9CC,IAAMN,KAAKO,iBAAiBN,WAC9BO,MAAQ,SACZF,IAAIG,SAASC,UACLC,YAAc,EACdC,IAAMF,IAAIG,aAAaX,OAAS,GAChCC,QAEa,SAATD,OACAU,IAAM,IAAMA,IAAIE,MAAM,KAAK,IAE3BC,OAAO,QAAQC,KAAKJ,OACpBF,IAAIO,aAAaf,KAAM,IAAME,OAASQ,IAAIM,UAAU,IACpDP,aAAe,IAEZI,OAAO,OAAOC,KAAKJ,OAC1BF,IAAIO,aAAaf,KAAME,OAASQ,KAChCD,aAAe,GAEfA,aAAeN,eACfA,cAAcK,KAElBF,OAASG,eAENH,eAMFH,cAAcK,WACbS,MAAQT,IAAIG,aAAa,MACjBH,IAAIH,iBAAiB,4FAC7BE,SAASW,OACXA,KAAKH,aAAa,cAAe,IAAME,OACvCC,KAAKH,aAAa,iBAAkB,IAAME,mBAQlCE,kBAAkBC,YAE1Bd,MAAQ,QACNR,KAAOsB,OAAOC,cAEhBf,OAAST,YAAYC,KAAM,6BAA8B,MAAM,EAJpD,KAImEK,qBACxEmB,OAASzB,YAAYC,KAAM,uBAAwB,QAAQ,EALtD,MAMPwB,OAAS,IACThB,OAASgB,OAASzB,YAAYC,KAAM,0BAA2B,MAAM,EAP9D,OASb,MAAOyB,IACLC,QAAQC,MAAMF,WAEXjB,MAAQ,6GAKboB,yBAA2B,CAE7B,SACA,SACA,SAEA,YACA,UACA,UACA,YACA,iBACA,QAIGC,aAAeD,yBAAyBE,KAAIC,QAAW,SAAQA,YAAWC,KAAK,8BAyD5E,mBAZYV,cACZW,SAAWZ,kBAAkBC,QAC7BY,kBAzCYZ,cACZtB,KAAOsB,OAAOC,cAChBY,QAAU,SAIwBnC,KAAKO,iBAAiBsB,cAE9BpB,SAAQ2B,UAElCR,yBAAyBnB,SAAQ4B,wBACvBC,YAAe,QAAOD,qBAGxBD,QAAQG,aAAaD,aAAc,OAC7BE,UAAYJ,QAAQvB,aAAayB,aACjCG,YAAe,WAAUJ,kBAIb,OAAdG,UACIJ,QAAQvB,aAAa4B,eAAiBD,YACtCJ,QAAQnB,aAAawB,YAAaD,WAClCL,YAGJC,QAAQM,gBAAgBD,aACxBN,kBAMTA,QAAU,EAQAQ,CAAarB,SAC1BW,UAAYC,WACZZ,OAAOsB,oBAAoBC,KAAK,CAC5BC,KAAM,2EACNC,KAAM,UACNC,QAAS"}