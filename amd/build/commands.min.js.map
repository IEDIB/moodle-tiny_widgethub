{"version":3,"file":"commands.min.js","sources":["../src/commands.js"],"sourcesContent":["/* eslint-disable no-console */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny WidgetHub plugin.\n *\n * @module      tiny_ibwidgethub/plugin\n * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getButtonImage} from 'editor_tiny/utils';\nimport * as coreStr from 'core/str';\nimport Common from './common';\nimport * as cfg from 'core/config';\nimport {initContextActions} from './contextinit';\nimport {getAdditionalCss, getGlobalConfig, getWidgetDict, isPluginVisible, Shared, getEditorOptions} from './options';\nimport jQuery from \"jquery\";\nimport {getWidgetPickCtrl} from './controller/widgetpicker_ctrl';\nimport {getListeners} from './extension';\nimport {getUserStorage} from './service/userstorage_service';\nimport {applyWidgetFilterFactory, findVariableByName, searchComp} from './util';\nimport { avoidScrollNonEditableZones, emulateAttoNewlineBehaviour } from './extension/newlinebehavior';\n\nexport const getSetup = async() => {\n    // Get some translations\n    const [widgetNameTitle, buttonImage] = await Promise.all([\n        coreStr.get_string('settings', Common.component),\n        getButtonImage('icon', Common.component),\n    ]);\n\n    /** @param {import('./plugin').TinyMCE} editor */\n    return (editor) => {\n        // Check if the option visible is set.\n        if (!isPluginVisible(editor)) {\n            // No capabilities required.\n            return;\n        }\n        // Click problem fix\n        const cfgLevel1 = getGlobalConfig(editor, 'avoid.scroll.noneditablezones', '0');\n        if (cfgLevel1 !== '0') {\n            console.log('avoid.scroll.noneditablezones=', cfgLevel1);\n            avoidScrollNonEditableZones(editor, cfgLevel1);\n        }\n\n        // Newline emulation\n        const cfgLevel2 = getGlobalConfig(editor, 'emulate.atto.newlinebehaviour', '0');\n        if (cfgLevel2 !== '0') {\n            console.log('emulate.atto.newlinebehaviour=', cfgLevel2);\n            emulateAttoNewlineBehaviour(editor);\n        }\n\n        // Check if there is a config option to disable the plugin for the current page.\n        const page = Shared.currentScope;\n        const disableList = getGlobalConfig(editor, \"disable.plugin.pages\", \"\")\n            .split(\",\")\n            .map(p => p.trim())\n            .filter(Boolean);\n\n        if (disableList.includes(page)) {\n            console.warn(\"WidgetHub plugin is disabled on this page.\");\n            return;\n        }\n\n        const regexPattern = getGlobalConfig(editor, \"disable.plugin.pages.regex\", \"\");\n        if (regexPattern) {\n            try {\n                const regex = new RegExp(regexPattern);\n                if (regex.test(page)) {\n                    console.warn(\"WidgetHub plugin is disabled on this page.\");\n                    return;\n                }\n            } catch (/** @type {any} */ ex) {\n                console.error(\"Please check disable.plugin.pages.regex: Invalid regular expression:\", ex.message);\n            }\n        }\n\n        // In case that CodePro is not installed in production, then resort to this mechanism\n        // to control the HTML filtering behaviour of TinyMCE.\n        editor.on('PreInit', () => {\n            const schema = editor.parser?.schema;\n            if (!schema) {\n                return;\n            }\n            // Apply HTML filtering options to the editor parser instance.\n            const customElements = getGlobalConfig(editor, \"tiny.custom_elements\", \"\").trim();\n            if (customElements) {\n                schema.addCustomElements(customElements);\n            }\n\n            const validElements = getGlobalConfig(editor, \"tiny.valid_elements\", \"\").trim();\n            if (validElements) {\n                schema.addValidElements(validElements);\n            }\n\n            const validChildren = getGlobalConfig(editor, \"tiny.valid_children\", \"\").trim();\n            if (validChildren) {\n                schema.addValidChildren(validChildren);\n            }\n        });\n\n        // Register the Icon.\n        editor.ui.registry.addIcon(Common.icon, buttonImage.html);\n\n        const defaultAction = () => {\n            const widgetPickCtrl = getWidgetPickCtrl(editor);\n            widgetPickCtrl.handleAction();\n        };\n\n        const storage = getUserStorage(editor);\n        const widgetsDict = getWidgetDict(editor);\n        // Register the Toolbar SplitButton - including recently used widgets\n        editor.ui.registry.addSplitButton(Common.component, {\n            icon: Common.icon,\n            tooltip: widgetNameTitle,\n            columns: 1,\n            fetch: (/** @type ((items: *[]) => void) */callback) => {\n                const items = storage.getRecentUsed().map(e => ({\n                    type: 'choiceitem',\n                    text: widgetsDict[e.key]?.name,\n                    value: e.key\n                })).filter(item => item.text !== undefined);\n                callback(items);\n            },\n            onAction: defaultAction,\n            onItemAction: (/** @type {*} */ api, /** @type {string} */ key) => {\n                const widgetPickCtrl = getWidgetPickCtrl(editor);\n                /** @type {Record<string, *>} */\n                let ctx = widgetsDict[key]?.defaults || {};\n                // Si hi ha preferències desades, empra-les\n                const ctxStored = storage.getRecentUsed().filter(e => e.key === key)[0]?.p || {};\n                ctx = {...ctx, ...ctxStored};\n                widgetPickCtrl.handlePickModalAction(widgetsDict[key], true, ctx);\n            }\n        });\n\n        // Add the Menu Item.\n        // This allows it to be added to a standard menu, or a context menu.\n        editor.ui.registry.addMenuItem(Common.component, {\n            icon: Common.icon,\n            text: widgetNameTitle,\n            onAction: defaultAction,\n        });\n\n        const getMatchedWidgets = (/** @type {string} */ pattern) => {\n            return Object.values(widgetsDict).filter((w) => searchComp(w.name, pattern));\n        };\n\n        // Add an Autocompleter @<search widget name>.\n        const autoCompleteTrigger = getGlobalConfig(editor, 'autocomplete.trigger', '@');\n        if (autoCompleteTrigger) {\n            editor.ui.registry.addAutocompleter(Common.component + '_autocompleter', {\n                trigger: autoCompleteTrigger,\n                columns: 1,\n                minChars: 3,\n                fetch: (/** @type {string}*/ pattern) => {\n                        /** @type {{type: string, value: string, text: string}[]} */\n                        const results = [];\n                        getMatchedWidgets(pattern).forEach((/** @type {import('./options').Widget} */ w) => {\n                            const varname = w.prop('autocomplete')?.trim();\n                            const param = findVariableByName(varname, w.parameters);\n                            if (!param?.options) {\n                                results.push({\n                                    type: 'autocompleteitem',\n                                    value: w.key,\n                                    text: w.name\n                                });\n                            } else {\n                                param.options.forEach(opt => {\n                                    let value = opt;\n                                    let label = opt;\n                                    if (typeof opt === 'object') {\n                                        value = opt.v;\n                                        label = opt.l;\n                                    }\n                                    results.push({\n                                        type: 'autocompleteitem',\n                                        value: `${w.key}|${varname}:${value}`,\n                                        text: w.name + \" \" + label\n                                    });\n                                });\n                            }\n                        });\n                        return Promise.resolve(results);\n                },\n                onAction: (/** @type {*}*/ api, /** @type {Range}*/ rng, /** @type {string}*/ value) => {\n                    api.hide();\n                    const pair = value.split('|');\n                    const key = pair[0].trim();\n                    /** @type {Record<string, *>} */\n                    let ctx = widgetsDict[key]?.defaults || {};\n                    // Si hi ha preferències desades, empra-les\n                    const ctxStored = storage.getRecentUsed().filter(e => e.key === key)[0]?.p || {};\n                    ctx = {...ctx, ...ctxStored};\n                    if (pair.length === 2) {\n                        const [varname, value] = pair[1].split(\":\");\n                        ctx[varname] = value;\n                    }\n                    editor.selection.setRng(rng);\n                    editor.insertContent('');\n                    const widgetPickCtrl = getWidgetPickCtrl(editor);\n                    widgetPickCtrl.handlePickModalAction(widgetsDict[key], true, ctx);\n                }\n            });\n        }\n\n        // Initialize context menus, styles and scripts into editor's iframe\n        initializer(editor);\n    };\n};\n\n/**\n * If the user has selected automatic apply of filters on startup, apply them!\n * @param {import('./plugin').TinyMCE} editor\n */\nconst autoFilter = (editor) => {\n    const storage = getUserStorage(editor);\n    const requiresFilter = storage.getFromLocal(\"startup.filters\", \"\").split(\",\");\n\n    if (requiresFilter.length > 0) {\n        const editorOptions = getEditorOptions(editor);\n        const widgetsFound = requiresFilter.map(key => editorOptions.widgetDict[key]).filter(w => w !== undefined);\n        const applyWidgetFilter = applyWidgetFilterFactory(editor, coreStr);\n\n        // Apply the filters and show the result\n        widgetsFound.forEach(w => applyWidgetFilter(w.template ?? '', true));\n\n        // Apply it also on save\n        const pageForm = document.querySelector('form.mform');\n        if (pageForm && pageForm.querySelector('div[data-fieldtype=\"editor\"]')) {\n            pageForm.addEventListener('submit', () => {\n                widgetsFound.forEach(w => applyWidgetFilter(w.template ?? '', true));\n                return true;\n            });\n        }\n    }\n};\n\n/**\n * Inject styles and scripts into editor's iframe\n * @param {import('./plugin').TinyMCE} editor\n */\nfunction initializer(editor) {\n    editor.once('SetContent', () => {\n        // Run all subscribers\n        autoFilter(editor);\n        getListeners('contentSet').forEach(listener => listener(editor));\n    });\n    // Add the bootstrap, CSS, etc... into the editor's iframe\n    editor.on('init', () => {\n        // On init editor.dom is ready\n        // Inject css all generated by Moodle into the editor's iframe\n        // http://localhost:4141/theme/styles.php/boost/1721728984_1/all\n        // TODO: Missing themesubrevision\n        const subversion = 1;\n        // @ts-ignore\n        const allCss = `${cfg.wwwroot}/theme/styles.php/${cfg.theme}/${cfg.themerev}_${subversion}/all`;\n        editor.dom.loadCSS(allCss);\n\n        // Inject styles and Javascript into the editor's iframe\n        // editor.dom.loadCSS(`${baseUrl}/libs/fontawesome/css/font-awesome.min.css`);\n        // Discover the jQuery version\n        // @ts-ignore\n        const jQueryVersion = jQuery.fn.jquery ?? '3.6.1';\n        const scriptJQ = editor.dom.create(\"script\", {src: `https://code.jquery.com/jquery-${jQueryVersion}.min.js`});\n        const head = editor.getDoc().querySelector(\"head\");\n        scriptJQ.onload = () => {\n            // Cannot load BS until JQ is fully loaded on editor's iframe\n            // @ts-ignore\n            const bsVersion = jQuery.fn.tooltip?.Constructor?.VERSION ?? '4.6.2';\n            const scriptBS = editor.dom.create(\"script\",\n                {src: `https://cdn.jsdelivr.net/npm/bootstrap@${bsVersion}/dist/js/bootstrap.bundle.min.js`});\n            head.appendChild(scriptBS);\n\n            // Activate popover and tooltips\n            scriptBS.onload = () => {\n                if (!editor.dom.get('init_bs_comp')) {\n                    const scriptInitBS = editor.dom.create(\"script\");\n                    scriptInitBS.id = 'init_bs_comp';\n                    scriptInitBS.innerHTML = `\n                    $(document).ready(function() {\n                        $('body').tooltip({\n                            selector: '[data-toggle=\"tooltip\"],[data-bs-toggle=\"tooltip\"]',\n                            trigger: 'hover'\n                        });\n                        $('body').popover({\n                            selector: '[data-toggle=\"popover\"],[data-bs-toggle=\"popover\"]',\n                            trigger: 'hover'\n                        });\n                    });`;\n                    head.appendChild(scriptInitBS);\n                }\n            };\n            // Run all subscribers\n            getListeners('onInit').forEach(listener => listener(editor));\n\n            // Inject css from site Admin\n            let adminCss = (getAdditionalCss(editor) ?? '').trim();\n            if (adminCss) {\n                // Commented URLs are interpreted as loadCss\n                const regex = /\\/\\*{2}\\s+(http(s?):\\/\\/.*)\\s+\\*{2}\\//gm;\n                adminCss = adminCss.replace(regex, (_, $1) => {\n                    editor.dom.loadCSS($1);\n                    return '';\n                });\n                if (adminCss.trim()) {\n                    editor.dom.addStyle(adminCss);\n                }\n            }\n\n            if (parseInt(getGlobalConfig(editor, 'enable.contextmenu.level', '1')) > 0) {\n                // Initialize context toolbars and menus\n                initContextActions(editor);\n            }\n        };\n\n        head.appendChild(scriptJQ);\n    });\n}\n"],"names":["async","widgetNameTitle","buttonImage","Promise","all","coreStr","get_string","Common","component","editor","cfgLevel1","console","log","cfgLevel2","page","Shared","currentScope","split","map","p","trim","filter","Boolean","includes","warn","regexPattern","RegExp","test","ex","error","message","on","schema","parser","_editor$parser","customElements","addCustomElements","validElements","addValidElements","validChildren","addValidChildren","ui","registry","addIcon","icon","html","defaultAction","handleAction","storage","widgetsDict","addSplitButton","tooltip","columns","fetch","callback","getRecentUsed","e","type","text","key","_widgetsDict$e$key","name","value","item","undefined","onAction","onItemAction","api","widgetPickCtrl","ctx","defaults","ctxStored","handlePickModalAction","addMenuItem","autoCompleteTrigger","addAutocompleter","trigger","minChars","pattern","results","Object","values","w","getMatchedWidgets","forEach","varname","prop","_w$prop","param","parameters","options","opt","label","v","l","push","resolve","rng","hide","pair","length","selection","setRng","insertContent","once","requiresFilter","getFromLocal","editorOptions","widgetsFound","widgetDict","applyWidgetFilter","template","pageForm","document","querySelector","addEventListener","autoFilter","listener","subversion","allCss","cfg","wwwroot","theme","themerev","dom","loadCSS","jQueryVersion","jQuery","fn","jquery","scriptJQ","create","src","head","getDoc","onload","bsVersion","Constructor","VERSION","scriptBS","appendChild","get","scriptInitBS","id","innerHTML","adminCss","regex","replace","_","$1","addStyle","parseInt","initializer"],"mappings":"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"}